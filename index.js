import dotenv from 'dotenv';
dotenv.config();

import express from 'express';
const app = express();
const PORT = process.env.PORT || 8000;
app.get('/', (req, res) => res.send('Bot is alive!'));
app.listen(PORT, () => {
  console.log(`Dummy web server running on port ${PORT}`);
});

import {
  Client,
  GatewayIntentBits,
  Collection,
  PermissionFlagsBits,
  AttachmentBuilder,
  SlashCommandBuilder,
  REST,
  Routes,
  ActionRowBuilder,
  ButtonBuilder,
  ButtonStyle,
  StringSelectMenuBuilder
} from 'discord.js';
import mongoose from 'mongoose';
import axios from 'axios';

import YoutubeVideo from './models/YoutubeVideo.js';
import numberToYoutubeUrl from './config/numberToYoutubeUrl.js';
import UserCoin from './models/UserCoin.js';

const MONGODB_URI = process.env.MONGODB_URI;
const TOKEN = process.env.TOKEN;
const CLIENT_ID = process.env.CLIENT_ID;
const GUILD_ID = process.env.GUILD_ID;
const TARGET_CHANNEL_ID = process.env.TARGET_CHANNEL_ID;
const DROP_NOTIFY_CHANNEL_ID = process.env.DROP_NOTIFY_CHANNEL_ID || TARGET_CHANNEL_ID;

const ADMIN_IDS = process.env.ADMIN_IDS ? process.env.ADMIN_IDS.split(',') : [];
const TOTAL_SALES_RESET_IDS = process.env.TOTAL_SALES_RESET_IDS ? process.env.TOTAL_SALES_RESET_IDS.split(',') : [];

const userMap = {
  '636419692353028103': '„ÅÜ„Å§„Çç„Åø„ÇÜ„ÇÄ',
  '1204420101529673752': '„Åè„Çã„Åø„Çì',
  '985863366100803594': 'Â∏ÜÁ´ã‰∏∏',
  '1051175275880259716': 'ÈÆ´Áî∞„Åï„ÅÇ„ÇÅ',
  '943525542030901249': '‰∏ÉÁÄ¨„ÅÆ„Çì',
  '774197905921015839': '„ÅÇ„ÅÑ„Çã',
  '1418491317855588352': '„Åä„ÅÑ„ÇÇ',
  '634002738014978071': 'Ëó§Â†Ç„É≠„Éü',
  '1175820346465722519': 'Ê∞∑Ëä±„Çå„Åç',
  '883685991766958080': 'Ëó§Â¥é‰∫åÈÉé',
  '425554535449231360': 'ËòáÁî∞„ÉÅ„Çß„É™Áî∑',
  '260067535397978122': '„Åè„Åæ„Çä„Çì',
  '736946638479949949': 'Á†Ç‰∫ïÁ†¥‰∫ú',
  '111222333444555666': '„Åè„Çç„Åø„Å§',
  '569215653882363916': 'Áå´Ë∞∑„Å™„ÇÜ',
  '935889095404687400': '„ÅÇ„Éº„Åô',
  '354060625334239235': '‰Ωê„ÄÖÊú®„Åï„Åñ„Çì„Åã',
  '712983286082699265': 'rapis',
  '1365266032272605324': 'rei',
  '712278533279318146': 'Ê∞∑Ëä±„Åó„Åà„Çã',
};

const COINS = [
  'binance-usd', 'polkadot', 'solana', 'bitcoin', 'binancecoin',
  'litecoin', 'dogecoin', 'ripple', 'usd-coin', 'shiba-inu',
  'ethereum', 'cardano', 'tether', 'bitcoin-cash'
];

const coinNames = {
  'binance-usd': 'BUSD',
  'polkadot': 'DOT',
  'solana': 'SOL',
  'bitcoin': 'BTC',
  'binancecoin': 'BNB',
  'litecoin': 'LTC',
  'dogecoin': 'DOGE',
  'ripple': 'XRP',
  'usd-coin': 'USDC',
  'shiba-inu': 'SHIB',
  'ethereum': 'ETH',
  'cardano': 'ADA',
  'tether': 'USDT',
  'bitcoin-cash': 'BCH'
};

const INTERVAL_MIN = 10;
const GACHA_GIF_URL = "https://3.bp.blogspot.com/-nCwQHBNVgkQ/W2QwH3KMGnI/AAAAAAABK4c/2P6EwT4c9wAlVjWbZKkA2A2iV1nR1lIvgCLcBGAs/s400/gacha_capsule_machine.gif";

// „É¶„Éº„Ç∂„ÉºÊØé„ÅÆÊâÄÊúâËÄÖÈÅ∏ÊäûÔºà„É°„É¢„É™‰øùÂ≠òÔºâ
const userOwnerSelection = {};

async function getCurrentPrices(coinIds = COINS, vsCurrency = 'usd') {
  const url = `https://api.coingecko.com/api/v3/simple/price?ids=${coinIds.join(',')}&vs_currencies=${vsCurrency}`;
  try {
    const res = await axios.get(url);
    return res.data;
  } catch (e) {
    console.error('‰æ°Ê†ºÂèñÂæóÂ§±Êïó:', e.message);
    return {};
  }
}

async function checkDrop(coinId, percent = 5) {
  try {
    const url = `https://api.coingecko.com/api/v3/coins/${coinId}/market_chart?vs_currency=usd&days=1`;
    const res = await axios.get(url);
    const prices = res.data.prices.map(([t, p]) => p);
    const maxPrice = Math.max(...prices);
    const nowPrice = prices[prices.length - 1];
    const dropRate = ((maxPrice - nowPrice) / maxPrice) * 100;
    if (dropRate >= percent) {
      return { coinId, dropRate: dropRate.toFixed(2), maxPrice, nowPrice };
    }
  } catch (e) {
    console.error(`[${coinId}] APIÂèñÂæó„Ç®„É©„Éº:`, e.message);
  }
  return null;
}

function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

const client = new Client({ intents: [
  GatewayIntentBits.Guilds,
  GatewayIntentBits.GuildMessages,
  GatewayIntentBits.MessageContent
] });

client.once('ready', () => {
  console.log(`Logged in as ${client.user.tag}`);

  setInterval(async () => {
    let notifyMsg = '';
    for (const coinId of COINS) {
      const drop = await checkDrop(coinId, 5);
      if (drop) {
        notifyMsg += `üü† **${coinNames[coinId] || coinId}** „Åå24h„Åß **${drop.dropRate}%ÊÄ•ËêΩ**ÔºÅ\nÔºàÊúÄÈ´òÂÄ§: $${drop.maxPrice.toFixed(4)}‚ÜíÁèæÂú®ÂÄ§: $${drop.nowPrice.toFixed(4)}Ôºâ\n`;
      }
    }
    if (notifyMsg) {
      try {
        const channel = await client.channels.fetch(DROP_NOTIFY_CHANNEL_ID);
        channel.send('„ÄêËá™ÂãïÁõ£Ë¶ñÈÄöÁü•„Äë\n' + notifyMsg);
      } catch (e) {
        console.error('ÊÄ•ËêΩÈÄöÁü•ÈÄÅ‰ø°„Ç®„É©„Éº:', e);
      }
    }
  }, INTERVAL_MIN * 60 * 1000);
});

// „Ç≥„Ç§„É≥Áµ¶‰ªò: !givecoin @user ÊûöÊï∞
client.on('messageCreate', async (message) => {
  if (message.author.bot) return;

  if (message.content.startsWith('!givecoin') && ADMIN_IDS.includes(message.author.id)) {
    const match = message.content.match(/!givecoin <@!?(\d+)>\s+(\d+)/);
    if (!match) return message.reply('‰Ωø„ÅÑÊñπÔºö!givecoin @user ÊûöÊï∞');
    const userId = match[1], coins = parseInt(match[2], 10);
    let userCoin = await UserCoin.findOne({ userId });
    if (!userCoin) userCoin = new UserCoin({ userId, coin: 0 });
    userCoin.coin += coins;
    await userCoin.save();
    message.reply(`<@${userId}> „Å´${coins}ÊûöÁµ¶‰ªò„Åó„Åæ„Åó„ÅüÔºàÁèæÂú®: ${userCoin.coin}ÊûöÔºâ`);
    return;
  }

  // „Ç¨„ÉÅ„É£„Éú„Çø„É≥Ôºã„Çª„É¨„ÇØ„Éà„É°„Éã„É•„ÉºË®≠ÁΩÆÔºàÁÆ°ÁêÜËÄÖ„ÅÆ„ÅøÔºâ
  if (message.content === '!gachabutton' && ADMIN_IDS.includes(message.author.id)) {
    const ownerOptions = Object.values(userMap).map(owner => ({
      label: owner,
      value: owner
    }));
    const selectMenu = new StringSelectMenuBuilder()
      .setCustomId('owner_select')
      .setPlaceholder('11ÈÄ£Á¢∫ÂÆöÊû†„ÅÆÊâÄÊúâËÄÖ„ÇíÈÅ∏Êäû')
      .addOptions(ownerOptions);

    const rowMenu = new ActionRowBuilder().addComponents(selectMenu);
    const rowButton = new ActionRowBuilder()
      .addComponents(
        new ButtonBuilder()
          .setCustomId('gacha_1')
          .setLabel('1ÂõûÂºï„Åè')
          .setStyle(ButtonStyle.Primary),
        new ButtonBuilder()
          .setCustomId('gacha_11')
          .setLabel('11ÂõûÂºï„Åè')
          .setStyle(ButtonStyle.Success)
      );
    await message.channel.send({
      content: '„Ç¨„ÉÅ„É£„ÇíÂºï„Åè„Éú„Çø„É≥ÔºÜÁ¢∫ÂÆöÊû†ÊâÄÊúâËÄÖÈÅ∏Êäû„ÅØ„Åì„Å°„ÇâÔºÅ',
      files: [GACHA_GIF_URL],
      components: [rowMenu, rowButton]
    });
    return;
  }

  // Êó¢Â≠ò„ÅÆÁï™Âè∑„Ç¨„ÉÅ„É£„Ç∑„Çπ„ÉÜ„É†ÔºàÂãïÁîªËøΩÂä†ÔºÜÂ£≤‰∏äÂèçÊò†Ôºâ
  if (message.channel.id === TARGET_CHANNEL_ID) {
    const num = parseInt(message.content, 10);
    if (!isNaN(num) && num >= 1 && num <= 69) {
      const url = numberToYoutubeUrl[num];
      if (url) {
        let video = await YoutubeVideo.findOne({ url });
        if (!video) {
          video = new YoutubeVideo({ url, count: 1, totalCount: 1 });
        } else {
          video.count += 1;
          video.totalCount = (typeof video.totalCount === 'number' ? video.totalCount : 0) + 1;
        }
        await video.save();
        await message.reply(
          `Áï™Âè∑${num}„ÅÆÂãïÁîªURL: ${url}\n` +
          (video.owner ? `ÊâÄÊúâËÄÖ: ${video.owner}` : 'ÊâÄÊúâËÄÖÊú™ÁôªÈå≤')
        );
      } else {
        await message.reply(`Áï™Âè∑${num}„Å´„ÅØÂãïÁîªURL„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ`);
      }
    }
  }
});

client.commands = new Collection();
const commands = [
  new SlashCommandBuilder()
    .setName('‰ª£ÁêÜÁôªÈå≤')
    .setDescription('ÂãïÁîªURL„ÅÆÊâÄÊúâËÄÖ„ÇíÁôªÈå≤ÔºàÁÆ°ÁêÜËÄÖ„ÅÆ„ÅøÔºâ')
    .addStringOption(option => option.setName('ÂãïÁîªurl').setDescription('ÂãïÁîªURL').setRequired(true))
    .addStringOption(option => option.setName('„É¶„Éº„Ç∂„ÉºÂêç').setDescription('ÊâÄÊúâËÄÖÂêç').setRequired(true))
    .setDefaultMemberPermissions(PermissionFlagsBits.Administrator),
  new SlashCommandBuilder()
    .setName('Á¥ØË®àÂ£≤‰∏ä')
    .setDescription('Ëá™ÂàÜËá™Ë∫´„ÅÆÁ¥ØË®àÂ£≤‰∏ä'),
  new SlashCommandBuilder()
    .setName('ÂãïÁîª„Ç∑„É£„ÉÉ„Éï„É´')
    .setDescription('Áï™Âè∑„Å®ÂãïÁîªURL„ÅÆÂâ≤„ÇäÂΩì„Å¶„Çí„É©„É≥„ÉÄ„É†„Ç∑„É£„ÉÉ„Éï„É´ÔºàÁÆ°ÁêÜËÄÖ„ÅÆ„ÅøÔºâ')
    .setDefaultMemberPermissions(PermissionFlagsBits.Administrator),
  new SlashCommandBuilder()
    .setName('Á¥ØË®àÂ£≤‰∏ä„É™„Çª„ÉÉ„Éà')
    .setDescription('ÂÖ®ÂãïÁîª„ÅÆÁ¥ØË®àÂ£≤‰∏ä„Çí„É™„Çª„ÉÉ„ÉàÔºàÁâπÂÆö„É¶„Éº„Ç∂„Éº„ÅÆ„ÅøÔºâ')
    .setDefaultMemberPermissions(PermissionFlagsBits.Administrator),
  new SlashCommandBuilder()
    .setName('Á¥ØË®àÂ£≤‰∏äÂ§âÊõ¥')
    .setDescription('Á¥ØË®àÂ£≤‰∏ä„ÅßÂá∫Âäõ„Åï„Çå„ÇãÊï∞„Çí„É¶„Éº„Ç∂„ÉºÂêçÊåáÂÆö„ÅßÂ§âÊõ¥ÔºàÁÆ°ÁêÜËÄÖ„ÅÆ„ÅøÔºâ')
    .addStringOption(option => option.setName('„É¶„Éº„Ç∂„ÉºÂêç').setDescription('ÊâÄÊúâËÄÖÂêç').setRequired(true))
    .addIntegerOption(option => option.setName('Â£≤‰∏äÊï∞').setDescription('Êñ∞„Åó„ÅÑÁ¥ØË®àÂ£≤‰∏äÊï∞').setRequired(true))
    .setDefaultMemberPermissions(PermissionFlagsBits.Administrator),
  new SlashCommandBuilder()
    .setName('ÂãïÁîª‰∏ÄË¶ß')
    .setDescription('ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„ÇãÂãïÁîªURL„ÅÆ‰∏ÄË¶ß„Çí„Éï„Ç°„Ç§„É´„ÅßÂá∫ÂäõÔºàÁÆ°ÁêÜËÄÖ„ÅÆ„ÅøÔºâ')
    .setDefaultMemberPermissions(PermissionFlagsBits.Administrator),
  new SlashCommandBuilder()
    .setName('Ââ≤„ÇäÂΩì„Å¶‰∏ÄË¶ß')
    .setDescription('ÁèæÂú®„ÅÆÁï™Âè∑„ÅÆÂãïÁîªÂâ≤„ÇäÂΩì„Å¶„Å®ÊâÄÊúâËÄÖ‰∏ÄË¶ß„Çí„Éï„Ç°„Ç§„É´„ÅßÂá∫ÂäõÔºàÁÆ°ÁêÜËÄÖ„ÅÆ„ÅøÔºâ')
    .setDefaultMemberPermissions(PermissionFlagsBits.Administrator),
  new SlashCommandBuilder()
    .setName('pricecheck')
    .setDescription('Áõ£Ë¶ñÈäòÊüÑ„ÅÆÁèæÂú®‰æ°Ê†º„Çí‰∏ÄË¶ßË°®Á§∫ÔºàÁÆ°ÁêÜËÄÖ„ÅÆ„ÅøÔºâ')
    .setDefaultMemberPermissions(PermissionFlagsBits.Administrator)
].map(cmd => cmd.toJSON());

const rest = new REST({ version: '10' }).setToken(TOKEN);

(async () => {
  try {
    await rest.put(
      Routes.applicationGuildCommands(CLIENT_ID, GUILD_ID),
      { body: commands }
    );
    console.log('Slash commands registered!');
  } catch (error) {
    console.error(error);
  }
})();

async function replyWithPossibleFile(interaction, replyMsg, filename = 'result.txt') {
  const buffer = Buffer.from(replyMsg, 'utf-8');
  const file = new AttachmentBuilder(buffer, { name: filename });
  await interaction.editReply({ content: '„Éï„Ç°„Ç§„É´„ÅßÂá∫Âäõ„Åó„Åæ„Åô„ÄÇ', files: [file] });
}

client.on('interactionCreate', async (interaction) => {
  try {
    // ÊâÄÊúâËÄÖ„Çª„É¨„ÇØ„Éà„É°„Éã„É•„ÉºÈÅ∏Êäû
    if (interaction.isStringSelectMenu() && interaction.customId === 'owner_select') {
      userOwnerSelection[interaction.user.id] = interaction.values[0];
      await interaction.reply({ content: `Á¢∫ÂÆöÊû†: ${interaction.values[0]}„ÇíÈÅ∏Êäû„Åó„Åæ„Åó„Åü`, ephemeral: true });
      return;
    }

    if (interaction.isButton()) {
      const userId = interaction.user.id;
      let userCoin = await UserCoin.findOne({ userId });
      if (!userCoin) userCoin = new UserCoin({ userId, coin: 0 });

      const count = (interaction.customId === 'gacha_11') ? 11 : 1;
      if (userCoin.coin < count) {
        await interaction.reply({ content: `„Ç≥„Ç§„É≥„ÅåË∂≥„Çä„Åæ„Åõ„ÇìÔºÅÔºàÊâÄÊåÅ: ${userCoin.coin}ÊûöÔºâ`, ephemeral: true });
        return;
      }
      userCoin.coin -= count;
      await userCoin.save();

      let results = [];
      if (count === 11 && userOwnerSelection[userId]) {
        const owner = userOwnerSelection[userId];
        const ownerVideos = await YoutubeVideo.find({ owner });
        if (ownerVideos.length > 0) {
          const video = ownerVideos[Math.floor(Math.random() * ownerVideos.length)];
          results.push(`„ÄêÁ¢∫ÂÆöÊû†„Äë${owner}: ${video.url}`);
        } else {
          results.push(`„ÄêÁ¢∫ÂÆöÊû†„Äë${owner}: ÊâÄÊúâËÄÖÂãïÁîª„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì`);
        }
      }
      for (let i = results.length; i < count; i++) {
        const num = Math.floor(Math.random() * 69) + 1;
        results.push(`Áï™Âè∑${num}: ${numberToYoutubeUrl[num]}`);
      }

      await interaction.reply({ content: `${count}ÂõûÂàÜ„ÅÆÁµêÊûú„ÇíDM„ÅßÈÄÅ„Çä„Åæ„Åó„ÅüÔºÅ`, ephemeral: true });
      await interaction.user.send(`üé∞ „Ç¨„ÉÅ„É£ÁµêÊûúÔºà${count}ÂõûÔºâ:\n` + results.join('\n'));
      return;
    }

    if (!interaction.isCommand()) return;

    await interaction.deferReply();

    const { commandName } = interaction;

    if (commandName === 'pricecheck') {
      if (!ADMIN_IDS.includes(interaction.user.id)) {
        await interaction.editReply('„Åì„ÅÆ„Ç≥„Éû„É≥„Éâ„ÅØÁÆ°ÁêÜËÄÖ„ÅÆ„ÅøÂÆüË°å„Åß„Åç„Åæ„Åô„ÄÇ');
        return;
      }
      const prices = await getCurrentPrices(COINS, 'usd');
      let replyMsg = '„ÄêÁõ£Ë¶ñÈäòÊüÑ ÁèæÂú®‰æ°Ê†º‰∏ÄË¶ßÔºàUSDÔºâ„Äë\n';
      for (const coinId of COINS) {
        const name = coinNames[coinId] || coinId;
        const price = prices[coinId]?.usd;
        replyMsg += `${name}: $${price ? price : 'ÂèñÂæóÂ§±Êïó'}\n`;
      }
      await interaction.editReply(replyMsg);
      return;
    }

    if (commandName === '‰ª£ÁêÜÁôªÈå≤') {
      if (!ADMIN_IDS.includes(interaction.user.id)) {
        await interaction.editReply('„Åì„ÅÆ„Ç≥„Éû„É≥„Éâ„ÅØÁÆ°ÁêÜËÄÖ„ÅÆ„ÅøÂÆüË°å„Åß„Åç„Åæ„Åô„ÄÇ');
        return;
      }
      const url = interaction.options.getString('ÂãïÁîªurl');
      const owner = interaction.options.getString('„É¶„Éº„Ç∂„ÉºÂêç');
      if (!url) {
        await interaction.editReply('ÂãïÁîªURL„ÅåÂÖ•Âäõ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ');
        return;
      }
      let video = await YoutubeVideo.findOne({ url });
      if (!video) {
        video = new YoutubeVideo({ url, owner, count: 0, totalCount: 0 }); // ÂàùÊúüÂåñ
      } else {
        video.owner = owner;
      }
      await video.save();
      await interaction.editReply(`ÂãïÁîªURL: ${url} „ÅÆÊâÄÊúâËÄÖ„Çí ${owner} „Å´ÁôªÈå≤„Åó„Åæ„Åó„Åü„ÄÇ`);
      return;
    }

    // Â£≤‰∏äÈõÜË®àÔºöÁÆ°ÁêÜËÄÖ„ÅØÂÖ®Âì°ÂàÜ„ÄÅ‰∏ÄËà¨„ÅØËá™ÂàÜ„Å†„Åë
    if (commandName === 'Á¥ØË®àÂ£≤‰∏ä') {
      const userId = interaction.user.id;
      const isAdmin = ADMIN_IDS.includes(userId);

      if (isAdmin) {
        const videos = await YoutubeVideo.find({});
        const userTotalSales = {};
        videos.forEach(v => {
          if (v.owner) {
            if (!userTotalSales[v.owner]) userTotalSales[v.owner] = 0;
            userTotalSales[v.owner] += typeof v.totalCount === 'number' ? v.totalCount : 0;
          }
        });
        let replyMsg = 'ÊâÄÊúâËÄÖ„Åî„Å®„ÅÆÁ¥ØË®àÂãïÁîªË≤©Â£≤Êï∞ÔºàÁ¥ØË®àË≤©Â£≤Êï∞√óÔºòÔºêÔºê‰∏áÔºâ:\n';
        let totalBooks = 0;
        let totalReward = 0;
        Object.entries(userTotalSales).forEach(([u, c]) => {
          const reward = c * 8000000;
          replyMsg += `${u}: ${c}Êú¨ÔºàÂ†±ÈÖ¨: ¬•${reward.toLocaleString()})\n`;
          totalBooks += c;
          totalReward += reward;
        });
        replyMsg += '--------------------\n';
        replyMsg += `ÂêàË®àÊú¨Êï∞: ${totalBooks}Êú¨\nÂêàË®àÂ†±ÈÖ¨ÈáëÈ°ç: ¬•${totalReward.toLocaleString()}\n`;
        const buffer = Buffer.from(replyMsg, 'utf-8');
        const file = new AttachmentBuilder(buffer, { name: 'total_sales.txt' });
        await interaction.editReply({ content: 'ÂÖ®Â£≤‰∏ä„Éá„Éº„Çø„Çí„Éï„Ç°„Ç§„É´„ÅßÂá∫Âäõ„Åó„Åæ„Åô„ÄÇ', files: [file] });
        return;
      } else {
        const ownerName = userMap[userId];
        if (!ownerName) {
          await interaction.editReply('„ÅÇ„Å™„Åü„ÅÆÊâÄÊúâËÄÖÂêç„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇÁÆ°ÁêÜËÄÖ„Å´„ÅîÈÄ£Áµ°„Åè„Å†„Åï„ÅÑ„ÄÇ');
          return;
        }
        const videos = await YoutubeVideo.find({ owner: ownerName });
        const count = videos.reduce((sum, v) => sum + (v.totalCount || 0), 0);
        const reward = count * 8000000;
        await interaction.editReply(
          `ÊâÄÊúâËÄÖ„Åî„Å®„ÅÆÁ¥ØË®àÂãïÁîªË≤©Â£≤Êï∞ÔºàÁ¥ØË®àË≤©Â£≤Êï∞√óÔºòÔºêÔºê‰∏áÔºâ:\n` +
          `${ownerName}: ${count}Êú¨ÔºàÂ†±ÈÖ¨: ¬•${reward.toLocaleString()})`
        );
        return;
      }
    }

    if (commandName === 'Á¥ØË®àÂ£≤‰∏äÂ§âÊõ¥') {
      if (!ADMIN_IDS.includes(interaction.user.id)) {
        await interaction.editReply('„Åì„ÅÆ„Ç≥„Éû„É≥„Éâ„ÅØÁÆ°ÁêÜËÄÖ„ÅÆ„ÅøÂÆüË°å„Åß„Åç„Åæ„Åô„ÄÇ');
        return;
      }
      const owner = interaction.options.getString('„É¶„Éº„Ç∂„ÉºÂêç');
      const newCount = interaction.options.getInteger('Â£≤‰∏äÊï∞');
      if (typeof newCount !== 'number' || newCount < 0) {
        await interaction.editReply('Â£≤‰∏äÊï∞„ÅØ0‰ª•‰∏ä„ÅÆÊï¥Êï∞„ÅßÊåáÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
        return;
      }
      const videos = await YoutubeVideo.find({ owner });
      if (videos.length === 0) {
        await interaction.editReply(`ÊâÄÊúâËÄÖ: ${owner} „ÅÆÂãïÁîª„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ`);
        return;
      }
      const perVideoCount = Math.floor(newCount / videos.length);
      let remainder = newCount % videos.length;
      for (const v of videos) {
        v.totalCount = perVideoCount + (remainder > 0 ? 1 : 0);
        if (remainder > 0) remainder--;
        await v.save();
      }
      await interaction.editReply(`ÊâÄÊúâËÄÖ: ${owner} „ÅÆÁ¥ØË®àÂ£≤‰∏äÔºà${newCount}Êú¨Ôºâ„ÇíDB„Å´„ÇÇÂèçÊò†„Åó„Åæ„Åó„Åü„ÄÇ`);
      return;
    }

    if (commandName === 'ÂãïÁîª„Ç∑„É£„ÉÉ„Éï„É´') {
      if (!ADMIN_IDS.includes(interaction.user.id)) {
        await interaction.editReply('„Åì„ÅÆ„Ç≥„Éû„É≥„Éâ„ÅØÁÆ°ÁêÜËÄÖ„Å†„Åë„ÅåÂÆüË°å„Åß„Åç„Åæ„Åô„ÄÇ');
        return;
      }
      const urls = Object.values(numberToYoutubeUrl);
      const shuffled = urls.sort(() => Math.random() - 0.5);
      Object.keys(numberToYoutubeUrl).forEach((num, idx) => {
        numberToYoutubeUrl[num] = shuffled[idx];
      });
      await interaction.editReply('Áï™Âè∑„Å®ÂãïÁîªURL„ÅÆÂâ≤„ÇäÂΩì„Å¶„Çí„É©„É≥„ÉÄ„É†„Å´„Ç∑„É£„ÉÉ„Éï„É´„Åó„Åæ„Åó„Åü„ÄÇ');
      return;
    }

    if (commandName === 'Á¥ØË®àÂ£≤‰∏ä„É™„Çª„ÉÉ„Éà') {
      if (!TOTAL_SALES_RESET_IDS.includes(interaction.user.id)) {
        await interaction.editReply('„Åì„ÅÆ„Ç≥„Éû„É≥„Éâ„ÅØÊåáÂÆö„É¶„Éº„Ç∂„Éº„ÅÆ„ÅøÂÆüË°å„Åß„Åç„Åæ„Åô„ÄÇ');
        return;
      }
      const videos = await YoutubeVideo.find({});
      for (const v of videos) {
        v.totalCount = 0;
        await v.save();
      }
      await interaction.editReply('ÂÖ®ÂãïÁîª„ÅÆÁ¥ØË®àÂ£≤‰∏ä„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åó„Åü„ÄÇ');
      return;
    }

    if (commandName === 'ÂãïÁîª‰∏ÄË¶ß') {
      if (!ADMIN_IDS.includes(interaction.user.id)) {
        await interaction.editReply('„Åì„ÅÆ„Ç≥„Éû„É≥„Éâ„ÅØÁÆ°ÁêÜËÄÖ„ÅÆ„ÅøÂÆüË°å„Åß„Åç„Åæ„Åô„ÄÇ');
        return;
      }
      const videos = await YoutubeVideo.find({});
      if (videos.length === 0) {
        await interaction.editReply('ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„ÇãÂãïÁîª„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ');
        return;
      }
      let replyMsg = 'ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„ÇãÂãïÁîªURL‰∏ÄË¶ß:\n';
      videos.forEach((v, idx) => {
        replyMsg += `${idx + 1}. ${v.url}${v.owner ? `ÔºàÊâÄÊúâËÄÖ: ${v.owner}Ôºâ` : ''}\n`;
      });
      await replyWithPossibleFile(interaction, replyMsg, 'videos.txt');
      return;
    }

    if (commandName === 'Ââ≤„ÇäÂΩì„Å¶‰∏ÄË¶ß') {
      if (!ADMIN_IDS.includes(interaction.user.id)) {
        await interaction.editReply('„Åì„ÅÆ„Ç≥„Éû„É≥„Éâ„ÅØÁÆ°ÁêÜËÄÖ„ÅÆ„ÅøÂÆüË°å„Åß„Åç„Åæ„Åô„ÄÇ');
        return;
      }
      let replyMsg = 'ÁèæÂú®„ÅÆÂãïÁîªÂâ≤„ÇäÂΩì„Å¶‰∏ÄË¶ß:\n';
      for (let num = 1; num <= 69; num++) {
        const url = numberToYoutubeUrl[num];
        if (!url) continue;
        const video = await YoutubeVideo.findOne({ url });
        replyMsg += `${num}: ${url}`;
        if (video && video.owner) {
          replyMsg += `ÔºàÊâÄÊúâËÄÖ: ${video.owner}Ôºâ`;
        }
        replyMsg += '\n';
      }
      await replyWithPossibleFile(interaction, replyMsg, 'assignments.txt');
      return;
    }
  } catch (err) {
    console.error(err);
    try {
      if (interaction.deferred || interaction.replied) {
        await interaction.editReply('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
      } else {
        await interaction.reply('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
      }
    } catch (_) {}
  }
});

process.on('unhandledRejection', (err) => {
  console.error('Unhandled promise rejection:', err);
});

mongoose.connect(MONGODB_URI)
  .then(() => {
    console.log('MongoDB connected');
    client.login(TOKEN);
  })
  .catch(err => console.error('MongoDB connection error:', err));
